#!/usr/bin/python
# -*- coding: utf-8 -*-

Micro_Font_5x5 = [
    0, 0, 0, 0, 0,
    10, 0, 4, 17, 14,
    10, 0, 0, 14, 17,
    27, 31, 31, 14, 4,
    0, 0, 0, 0, 0,
    0, 4, 10, 4, 14,
    4, 14, 14, 4, 14,
    0, 14, 14, 14, 0,
    0, 0, 0, 0, 0,
    0, 4, 10, 4, 0,
    0, 0, 0, 0, 0,
    30, 28, 31, 21, 7,
    5, 13, 31, 12, 4,
    20, 22, 31, 6, 4,
    15, 10, 10, 10, 5,
    21, 14, 27, 14, 21,
    4, 12, 28, 12, 4,
    4, 6, 7, 6, 4,
    4, 14, 4, 14, 4,
    10, 10, 10, 0, 10,
    12, 11, 10, 10, 10,
    0, 0, 0, 0, 0,
    0, 0, 0, 31, 31,
    0, 0, 0, 0, 0,
    4, 14, 21, 4, 4,
    4, 4, 21, 14, 4,
    4, 8, 31, 8, 4,
    4, 2, 31, 2, 4,
    0, 2, 2, 30, 0,
    0, 14, 14, 14, 0,
    4, 14, 31, 0, 0,
    0, 0, 31, 14, 4,
    0, 0, 0, 0, 0,
    4, 4, 4, 0, 4,
    10, 10, 0, 0, 0,
    10, 31, 10, 31, 10,
    31, 5, 31, 20, 31,
    17, 8, 4, 2, 17,
    6, 9, 22, 9, 22,
    8, 4, 0, 0, 0,
    8, 4, 4, 4, 8,
    2, 4, 4, 4, 2,
    21, 14, 31, 14, 21,
    0, 4, 14, 4, 0,
    0, 0, 0, 4, 2,
    0, 0, 14, 0, 0,
    0, 0, 0, 0, 2,
    8, 4, 4, 4, 2,
    14, 25, 21, 19, 14,
    4, 6, 4, 4, 14,
    14, 8, 14, 2, 14,
    14, 8, 12, 8, 14,
    2, 2, 10, 14, 8,
    14, 2, 14, 8, 14,
    6, 2, 14, 10, 14,
    14, 8, 12, 8, 8,
    14, 10, 14, 10, 14,
    14, 10, 14, 8, 14,
    0, 4, 0, 4, 0,
    0, 4, 0, 4, 2,
    8, 4, 2, 4, 8,
    0, 14, 0, 14, 0,
    2, 4, 8, 4, 2,
    14, 17, 12, 0, 4,
    14, 9, 5, 1, 14,
    6, 9, 17, 31, 17,
    7, 9, 15, 17, 15,
    14, 17, 1, 17, 14,
    15, 25, 17, 17, 15,
    31, 1, 15, 1, 31,
    31, 1, 15, 1, 1,
    14, 1, 25, 17, 14,
    9, 17, 31, 17, 17,
    14, 4, 4, 4, 14,
    12, 8, 8, 10, 14,
    9, 5, 3, 5, 9,
    1, 1, 1, 1, 15,
    17, 27, 21, 17, 17,
    17, 19, 21, 25, 17,
    14, 25, 17, 17, 14,
    7, 9, 7, 1, 1,
    14, 17, 17, 25, 30,
    7, 9, 7, 5, 9,
    30, 1, 14, 16, 15,
    31, 4, 4, 4, 4,
    9, 17, 17, 17, 14,
    10, 10, 10, 10, 4,
    9, 17, 21, 21, 10,
    17, 10, 4, 10, 17,
    17, 10, 4, 4, 4,
    31, 8, 4, 2, 31,
    12, 4, 4, 4, 12,
    2, 4, 4, 4, 8,
    6, 4, 4, 4, 6,
    4, 10, 0, 0, 0,
    0, 0, 0, 0, 14,
    4, 8, 0, 0, 0,
    6, 9, 17, 31, 17,
    7, 9, 15, 17, 15,
    14, 17, 1, 17, 14,
    15, 25, 17, 17, 15,
    31, 1, 15, 1, 31,
    31, 1, 15, 1, 1,
    14, 1, 25, 17, 14,
    9, 17, 31, 17, 17,
    14, 4, 4, 4, 14,
    12, 8, 8, 10, 14,
    18, 10, 6, 10, 18,
    1, 1, 1, 1, 15,
    17, 27, 21, 17, 17,
    17, 19, 21, 25, 17,
    14, 25, 17, 17, 14,
    7, 9, 7, 1, 1,
    14, 17, 17, 25, 30,
    7, 9, 7, 5, 9,
    30, 1, 14, 16, 15,
    31, 4, 4, 4, 4,
    9, 17, 17, 17, 14,
    10, 10, 10, 10, 4,
    9, 17, 21, 21, 10,
    17, 10, 4, 10, 17,
    17, 10, 4, 4, 4,
    31, 8, 4, 2, 31,
    12, 4, 2, 4, 12,
    4, 4, 4, 4, 4,
    6, 4, 8, 4, 6,
    10, 5, 0, 0, 0,
    0, 4, 10, 10, 14,
    0, 0, 0, 0, 0,
    10, 0, 10, 10, 14,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    10, 0, 14, 10, 30,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    31, 17, 17, 17, 31,
    0, 14, 10, 14, 0,
    0, 0, 4, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 4, 0, 0,
    0, 14, 10, 14, 0,
    0, 0, 0, 0, 0,
    10, 0, 14, 10, 30,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    10, 0, 14, 10, 14,
    0, 0, 0, 0, 0,
    3, 25, 11, 9, 11,
    28, 23, 21, 21, 29,
    0, 3, 1, 1, 1,
    10, 0, 14, 10, 14,
    10, 0, 10, 10, 14,
    0, 0, 0, 0, 31,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 31,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 31,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    4, 0, 6, 17, 14,
    0, 0, 28, 4, 4,
    0, 0, 7, 4, 4,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    4, 0, 4, 4, 4,
    4, 18, 9, 18, 4,
    4, 9, 18, 9, 4,
    0, 10, 0, 10, 0,
    10, 21, 10, 21, 10,
    21, 10, 21, 10, 21,
    4, 4, 4, 4, 4,
    4, 4, 7, 4, 4,
    4, 7, 4, 7, 4,
    10, 10, 11, 10, 10,
    0, 0, 15, 10, 10,
    0, 7, 4, 7, 4,
    10, 11, 8, 11, 10,
    10, 10, 10, 10, 10,
    0, 15, 8, 11, 10,
    10, 11, 8, 15, 0,
    10, 10, 15, 0, 0,
    4, 7, 4, 7, 0,
    0, 0, 7, 4, 4,
    4, 4, 28, 0, 0,
    4, 4, 31, 0, 0,
    0, 0, 31, 4, 4,
    4, 4, 28, 4, 4,
    0, 0, 31, 0, 0,
    4, 4, 31, 4, 4,
    4, 28, 4, 28, 4,
    10, 10, 26, 10, 10,
    10, 26, 2, 30, 0,
    0, 30, 2, 26, 10,
    10, 27, 0, 31, 0,
    0, 31, 0, 27, 10,
    10, 26, 2, 26, 10,
    0, 31, 0, 31, 0,
    10, 27, 0, 27, 10,
    4, 31, 0, 31, 0,
    10, 10, 31, 0, 0,
    0, 31, 0, 31, 4,
    0, 0, 31, 10, 10,
    10, 10, 30, 0, 0,
    4, 28, 4, 28, 0,
    0, 28, 4, 28, 4,
    0, 0, 30, 10, 10,
    10, 10, 31, 10, 10,
    4, 31, 4, 31, 4,
    4, 4, 7, 0, 0,
    0, 0, 28, 4, 4,
    31, 31, 31, 31, 31,
    0, 0, 31, 31, 31,
    3, 3, 3, 3, 3,
    24, 24, 24, 24, 24,
    31, 31, 31, 0, 0,
    0, 0, 0, 0, 0,
    6, 9, 13, 17, 13,
    0, 0, 0, 0, 0,
    14, 17, 17, 17, 14,
    0, 4, 10, 4, 0,
    0, 0, 4, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 4, 0, 0,
    0, 4, 10, 4, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 14, 31, 14, 0,
    16, 14, 10, 14, 1,
    12, 2, 14, 2, 12,
    6, 9, 9, 9, 9,
    14, 0, 14, 0, 14,
    4, 14, 4, 0, 14,
    2, 4, 8, 4, 14,
    8, 4, 2, 4, 14,
    8, 20, 4, 4, 4,
    4, 4, 4, 5, 2,
    4, 0, 14, 0, 4,
    10, 5, 0, 10, 5,
    4, 14, 4, 0, 0,
    0, 14, 14, 14, 0,
    0, 0, 4, 0, 0,
    24, 8, 11, 10, 4,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
    0, 0, 0, 0, 0
]


class BdfCharacter:
    def __init__(self, code_point, bitmap_array):
        self.code_point = code_point
        self.bitmap_array = bitmap_array

    def as_text_lines(self):
        return [
            'STARTCHAR char%d' % self.code_point,
            'ENCODING %d' % self.code_point,
            'SWIDTH 225 0',
            'DWIDTH 5 0',
            'BBX 5 5 0 0',
            'BITMAP',
            '%.2x' % self.reverse_bit_order(self.bitmap_array[0]),
            '%.2x' % self.reverse_bit_order(self.bitmap_array[1]),
            '%.2x' % self.reverse_bit_order(self.bitmap_array[2]),
            '%.2x' % self.reverse_bit_order(self.bitmap_array[3]),
            '%.2x' % self.reverse_bit_order(self.bitmap_array[4]),
            'ENDCHAR'
        ]

    def reverse_bit_order(self, byte):
        result = 0
        for i in xrange(8):
            if (byte >> i) & 1: result |= 1 << (8 - 1 - i)
        return result


class BdfWriter:
    __BDF_ENCODING = 'ASCII'
    __BDF_NEW_LINE_SEPARATOR = str('\r\n'.encode(encoding=__BDF_ENCODING))
    __BDF_START_FONT = [
        'STARTFONT 2.2',
        'COMMENT A monospaced micro font. Uppercase chars only.',
        'FONT -Nitram-Micro-Mono',
        'SIZE 5 320 200',
        'FONTBOUNDINGBOX 5 5 0 0',
        'STARTPROPERTIES 4',
        'MinSpace "5"',
        'Copyright "Copyright (c) 1996 Martin W. Kirst"',
        'FONT_ASCENT 5',
        'FONT_DESCENT 5',
        'ENDPROPERTIES',
    ]

    def __init__(self, file_name):
        self.__chars = []
        self.data = []
        self.bdf_file = file(file_name, "w")

    def add_char(self, bdf_character):
        self.__chars.append(bdf_character)

    def write_header(self):
        for line in self.__BDF_START_FONT:
            self.bdf_file.write(line)
            self.__write_new_line()
        self.__write_bdf_number_of_chars()

    def write_chars(self):
        for character in self.__chars:
            for line in character.as_text_lines():
                self.bdf_file.write(line)
                self.__write_new_line()

    def close(self):
        self.__write_bdf_end_font()
        self.bdf_file.close()

    def __write_bdf_end_font(self):
        self.bdf_file.write('ENDFONT')
        self.__write_new_line()

    def __write_bdf_number_of_chars(self):
        self.bdf_file.write('CHARS %d' % len(self.__chars))
        self.__write_new_line()

    def __write_new_line(self):
        self.bdf_file.write(self.__BDF_NEW_LINE_SEPARATOR)


def create_char(idx):
    code_point = ord(unicode(chr(idx), encoding='CP437', errors='strict'))
    print ">>> idx=%.2x codepoint=%.4x" % (idx, code_point)
    return BdfCharacter(code_point, Micro_Font_5x5[5 * idx:5 * idx + 5])


def is_char_defined(idx):
    black_list = [
        0x00,  # empty
        0x04,  # empty
        0x08,  # empty
        0x0A,  # empty
        0x17,  # empty
        0x80,  # empty
        0x82,  # empty
        0x83,  # empty
        0x85,  # empty
        0x86,  # empty
        0x8A,  # empty
        0x8D,  # empty
        0x8F,  # empty
        0x90,  # empty
        0x91,  # empty
        0x92,  # empty
        0x93,  # empty
        0x95,  # empty
        0x96,  # wrong bitmap
        0x97,  # wrong bitmap
        0x98,  # wrong bitmap
        0x9C,  # empty
        0x9E,  # empty
        0xA0,  # empty
        0xA1,  # empty
        0xA2,  # empty
        0xA3,  # empty
        0xA4,  # empty
        0xA5,  # empty
        0xA6,  # empty
        0xA7,  # empty
        0xAB,  # empty
        0xAC,  # empty
        0xE0,  # empty
        0xE2,  # empty
        0xE6,  # empty
        0xE9,  # empty
        0xEA,  # empty
        0xEB,  # empty
        0xFC,  # empty
        0xFD,  # empty
        0xFE,  # empty
        0xFF,  # empty
        0x0C,  # wrong bitmap
        0x0D,  # wrong bitmap
        0x1D,  # wrong bitmap
        0x87,  # wrong bitmap
        0x88,  # wrong bitmap
        0x89,  # wrong bitmap
        0x8B,  # wrong bitmap
        0x8C,  # wrong bitmap
        0x9B,  # wrong bitmap
        0x9D,  # wrong bitmap
        0x9F,  # wrong bitmap
        0xE3,  # wrong bitmap
        0xE4,  # wrong bitmap
        0xE5,  # wrong bitmap
        0xE7,  # wrong bitmap
        0xE8,  # wrong bitmap
        0xEC,  # wrong bitmap
        0xF8,  # wrong bitmap

    ]
    return idx not in black_list


if __name__ == '__main__':
    bdf_writer = BdfWriter('nitram-micro-mono.bdf')
    bdf_writer.write_header()
    for i in xrange(len(Micro_Font_5x5) / 5):
        if is_char_defined(i):
            bdf_writer.add_char(create_char(i))
    bdf_writer.write_chars()
    bdf_writer.close()
